# Unified gRPC Pipeline

The observer Expert Advisor serialises trade and metric events with the
Protocol Buffer definitions in `proto/trade_event.proto` and
`proto/metric_event.proto`.  Events are sent to a Python service over gRPC,
replacing the previous Arrow Flight and sharedâ€‘memory transports.

The EA loads `observer_grpc.dll` which exposes helpers to encode the messages
and to transmit them using `GrpcSendTrade` and `GrpcSendMetrics`.  The target
host and port are configured via the `GrpcServerHost` and `GrpcServerPort`
inputs.

On the server side `scripts/grpc_log_service.py` implements the
`tbot.LogService` with `LogTrade` and `LogMetrics` RPCs.  Each request is
appended to CSV files for downstream processing.

### Buffering and backpressure

`Observer_TBot.mq4` queues encoded trade and metric payloads in ring buffers
(`pending_trades` and `pending_metrics`). `LogTrade` and `WriteMetrics`
push messages into these buffers and the `OnTimer` handler periodically
drains them via `GrpcSendTrade` and `GrpcSendMetrics`. Failed sends are
retried with exponential backoff. Separate counters
`trade_retry_count` and `metric_retry_count` track consecutive failures
for each stream, and an alert is printed when either exceeds
`FallbackRetryThreshold`. Both counters are exported through
`SerializeMetrics`, allowing monitoring to distinguish which stream is
failing.

The Python `scripts/metrics_collector.py` tool exposes these counters as
Prometheus gauges and emits warnings when they grow, allowing operators to
alert on gRPC backpressure or outages.

Protobuf and gRPC stubs can be regenerated by running:

```bash
./scripts/gen_protos.sh
```

Start the logging service with:

```bash
python -m scripts.grpc_log_service --port 50051
```

This setup provides a single, reliable path for streaming telemetry from
MetaTrader to Python.
